<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAT - Secretaria de Estado do Meio Ambiente</title>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>
<body>
    <h1>CHAT</h1>

    <input type="text" name="usuario" placeholder="Digite seu usuÃ¡rio" />
    <button id="btnSalvarUsuario">OK</button>

    <input type="text" name="primeiraMensagem" placeholder="Digite a primeira mensagem" />
    <button id="btnNovaThread">Criar nova Thread</button>

    <div class="threads"></div>

    <script>
        const socket = io();

        const inputUsuario = $('input[name=usuario]');
        const inputNovaThread = $('input[name=primeiraMensagem]');
        const divThreads = $('.threads');
        let contadorThreads = 0;
        let usuario = '';

        $('#btnSalvarUsuario').on('click', () => {
            inputUsuario.prop('disabled', true);
            usuario = inputUsuario.val();
            $('#btnSalvarUsuario').remove();
        });

        const imprimeMensagem = (pacoteMensagem) => {
            $(`form[id=${pacoteMensagem.thread}] > div.mensagensThread`).append(`<div class="mensagem"><strong>${pacoteMensagem.hora} - ${pacoteMensagem.usuario}</strong>: ${pacoteMensagem.mensagem}</div>`);
        };

        const geraNovaMensagem = (inputTexto, thread) => {
            if (usuario.length && inputTexto.val().length) {
                    const pacoteMensagem = {
                        thread: thread,
                        hora: getHora(),
                        usuario: usuario,
                        mensagem: inputTexto.val()
                    }

                    socket.emit('novaMensagem', pacoteMensagem);

                    imprimeMensagem(pacoteMensagem);
                    inputTexto.val('');
                }
        }

        const criaSubmitListener = (contadorThreads) => {
            $(`form[id=thread${contadorThreads}]`).submit((event) => {
                event.preventDefault();

                const mensagem = $(`form[id=${event.target.id}] > input[name=novaMensagem]`)

                geraNovaMensagem(mensagem, event.target.id);
            })
        };

        $('#btnNovaThread').on('click', () => {
            if(!inputNovaThread.val().length || !usuario.length){
                return false;
            }
            contadorThreads++;
            divThreads.append(`
                <div class="thread">
                    <form id="thread${contadorThreads}">
                        <label>Thread ${contadorThreads}</label>
                        <div class="mensagensThread"></div>
                        <input type="text" name="novaMensagem" />
                    </form>
                <div>    
            `);
            
            criaSubmitListener(contadorThreads);
            geraNovaMensagem(inputNovaThread, `thread${contadorThreads}`);
        });

        const getHora = () => {
            const data = new Date();
            return `${data.toLocaleTimeString('pt-br', {timeStyle: 'short'})}`;
        };
        
    </script>
</body>
</html>