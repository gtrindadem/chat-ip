<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAT - Secretaria de Estado do Meio Ambiente</title>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>
<body>
    <h1>CHAT</h1>

    <input type="text" name="usuario" placeholder="Digite seu usuÃ¡rio" />
    <button id="btnSalvarUsuario">OK</button>

    <input type="text" name="primeiraMensagem" placeholder="Digite a primeira mensagem" />
    <button id="btnNovaThread">Criar nova Thread</button>

    <div class="threads"></div>

    <script>
        const socket = io();

        const inputUsuario = $('input[name=usuario]');
        const inputNovaThread = $('input[name=primeiraMensagem]');
        const divThreads = $('.threads');
        let threadIdAtual = 0;
        let usuario = '';

        const imprimeMensagem = (pacoteMensagem) => {
            $(`.mensagensThread${pacoteMensagem.threadId}`)
                .append(`
                    <div class="mensagem">
                        <strong>${pacoteMensagem.hora} - ${pacoteMensagem.usuario}</strong>: ${pacoteMensagem.mensagem}
                    </div>`
                );
        };

        socket.on('mensagensAnteriores', (pacotesMensagem) => {
            for (pacoteMensagem of pacotesMensagem) {
                imprimeMensagem(pacoteMensagem);
            }
        });

        socket.on('threadsAnteriores', (threadsId) => {
            threadIdAtual = threadsId.length;
            for (threadId of threadsId) {
                criaThread(threadId);
            }
        });

        socket.on('mensagemRecebida', (pacoteNovaMensagem) => {
            imprimeMensagem(pacoteNovaMensagem);
        });

        socket.on('threadRecebida', (threadId) => {
            threadIdAtual = threadId;
            criaThread(threadIdAtual);
        });

        

        $('#btnNovaThread').on('click', () => {
            if(!inputNovaThread.val().length || !usuario.length){
                return false;
            }

            threadIdAtual++
            criaThread(threadIdAtual);
            socket.emit('novaThread', threadIdAtual);

            const pacotePrimeiraMensagem = geraPacoteMensagem(usuario, threadIdAtual, inputNovaThread.val());
            imprimeMensagem(pacotePrimeiraMensagem);
            socket.emit('novaMensagem', pacotePrimeiraMensagem);
            inputNovaThread.val('');
        });

        const criaThread = (threadId) => {
            divThreads.append(`
                <div class="thread">
                    <form id="Thread${threadId}">
                        <label>Thread ${threadId}</label>
                        <div class="mensagensThread${threadId}"></div>
                        <input type="text" name="novaMensagem" />
                    </form>
                <div>
            `);

            criaSubmitListener(threadId);
        };

        const criaSubmitListener = (threadId) => {
            $(`form[id=Thread${threadId}]`).submit((event) => {
                event.preventDefault();

                const inputNovaMensagem = $(`form[id=Thread${threadId}] > input[name=novaMensagem]`);

                const pacoteNovaMensagem = geraPacoteMensagem(usuario, threadId, inputNovaMensagem.val());
                imprimeMensagem(pacoteNovaMensagem);
                socket.emit('novaMensagem', pacoteNovaMensagem);
                inputNovaMensagem.val('');
            })
        };

        const geraPacoteMensagem = (usuario, threadId, mensagem) => {
            return {
                usuario: usuario,
                threadId: threadId,
                mensagem: mensagem,
                hora: getHora()
            }
        }

        const getHora = () => {
            const data = new Date();
            return `${data.toLocaleTimeString('pt-br', {timeStyle: 'short'})}`;
        };
        
        $('#btnSalvarUsuario').on('click', () => {
            inputUsuario.prop('disabled', true);
            usuario = inputUsuario.val();
            $('#btnSalvarUsuario').remove();
        });

    </script>
</body>
</html>